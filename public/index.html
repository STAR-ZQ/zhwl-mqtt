<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- import CSS -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/element-ui/2.13.2/theme-chalk/index.css">
    <!-- import Vue before Element -->
    <script src="https://cdn.bootcdn.net/ajax/libs/vue/2.6.9/vue.min.js"></script>
    <!-- import JavaScript -->
    <script src="https://cdn.bootcdn.net/ajax/libs/element-ui/2.13.2/index.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/axios/0.21.0/axios.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/lodash.js/4.17.20/lodash.min.js"></script>


</head>

<body>
    <div id="app">
        <el-container>
            <el-header style=" height:1.5rem;text-align:center;">设备调试</el-header>
            <el-main>
                <el-row :gutter="20">
                    <el-col :md="24" :lg="6" class="card-list" style="padding-left: 10px;padding-right: 10px;">
                        <el-card class="box-card">
                            <div slot="header" class="clearfix">
                                <span>订阅设备</span>
                            </div>
                            <div>
                                <el-form :inline="true" :model="formDeviceAdd" :rules="rules" ref="formDeviceAdd">
                                    <el-form-item label="设备ID">
                                        <el-input v-model="formDeviceAdd.device_id" placeholder="设备ID" required>
                                        </el-input>
                                    </el-form-item>
                                    <el-form-item>
                                        <el-button type="primary" @click="onDeviceAdd">添加</el-button>
                                    </el-form-item>
                                </el-form>
                            </div>
                        </el-card>

                        <el-card class="box-card">
                            <div slot="header" class="clearfix">
                                <span>功能</span>
                            </div>
                            <div>
                                <el-form :model="formDeviceSelect" ref="formDeviceSelect">
                                    <el-form-item label="设备">
                                        <el-select v-model="formDeviceSelect.device_id" filterable allow-create
                                            default-first-option placeholder="选择或输入" @change="selectChange">
                                            <el-option v-for="item in devices" :key="item.device_id"
                                                :label="item.device_id" :value="item.device_id">
                                            </el-option>
                                        </el-select>
                                    </el-form-item>
                                </el-form>

                                <template>
                                    <el-tabs v-model="funTabActiveName" type="card">

                                        <el-tab-pane label="动作" name="action">
                                            <el-form label-position="top" :model="formDeviceAction"
                                                ref="formDeviceAction">

                                                <el-drvider></el-drvider>
                                                <el-form-item label="开关">
                                                    <el-button type="primary" size="small" plain @click="onSwitchAdd">新增
                                                    </el-button>
                                                    <el-button type="primary" size="small" plain @click="onSwitchReset">
                                                        重置
                                                    </el-button>


                                                    <div v-show="isShow" v-for="(item,index) in num">
                                                        <label></label>开关{{item.indexs}}</label>
                                                        <el-radio v-model="item.status" :label="1">开</el-radio>
                                                        <el-radio v-model="item.status" :label="0">关</el-radio>
                                                        <el-button type="primary" plain size="small"
                                                            @click="del(index)">删除</el-button>
                                                    </div>
                                                    <el-button type="primary" plain size="small" @click="onDeviceAction"
                                                        data-action="switchInfo">
                                                        发送</el-button>

                                                </el-form-item>

                                                <el-divider></el-divider>

                                                <el-form-item label="调光">
                                                    <div class="block">
                                                        <span class="demonstration">PWM</span>
                                                        <el-slider v-model="pwm" data-action="pwm"
                                                            @change="onDeviceActionPwm"></el-slider>
                                                    </div>
                                                    <div class="block">
                                                        <span class="demonstration">0-10V</span>
                                                        <el-slider v-model="v0_10" data-action="v0_10"
                                                            @change="onDeviceActionV0_10"></el-slider>
                                                    </div>
                                                </el-form-item>
                                            </el-form>
                                        </el-tab-pane>

                                        <el-tab-pane label="数据" name="data">
                                            <el-form label-position="top" :model="formDeviceTag" ref="formDeviceTag">
                                                <label>线路：</label>
                                                <!-- <el-form-item> -->
                                                <el-select v-model="formDeviceTag.line_id" filterable allow-create
                                                    default-first-option placeholder="选择或输入">
                                                    <el-option v-for="(lineId, index) in device.switchNum" :key="index"
                                                        :label="index" :value="index">
                                                    </el-option>
                                                </el-select>
                                                <!-- </el-form-item> -->
                                                <br>
                                                <br>
                                                <div style="width: 70%;margin-left: 30px;margin-top: 0;">
                                                    <el-checkbox-group v-model="checkboxTag" @change="getCheckTagValue">
                                                        <!-- <el-checkbox :indeterminate="isIndeterminate" v-model="checkAll">全选</el-checkbox> -->
                                                        <el-checkbox v-for="tag in tags" :key="tag.key" :label="tag.key"
                                                            :value="tag.key">{{tag.value}}</el-checkbox>
                                                    </el-checkbox-group>
                                                </div>
                                                <br>
                                                <el-button type="primary" plain size="small" @click="onDeviceTag">获取
                                                </el-button>

                                            </el-form>
                                        </el-tab-pane>

                                        <el-tab-pane label="配置" name="cfg">

                                            <el-tabs v-model="cfgTabActiveName" tab-position="left">

                                                <el-tab-pane label="MQTT" name="cfg_mqtt">
                                                    <el-form label-position="right" label-width="4.5rem"
                                                        :model="formDeviceCfg" ref="formDeviceCfg">
                                                        <el-form-item label="地址">
                                                            <el-input v-model="formDeviceCfg.mqtt.server"></el-input>
                                                        </el-form-item>
                                                        <el-form-item label="端口">
                                                            <el-input v-model="formDeviceCfg.mqtt.port"></el-input>
                                                        </el-form-item>
                                                        <el-form-item label="用户名">
                                                            <el-input v-model="formDeviceCfg.mqtt.username"></el-input>
                                                        </el-form-item>
                                                        <el-form-item label="密码">
                                                            <el-input v-model="formDeviceCfg.mqtt.password"></el-input>
                                                        </el-form-item>
                                                        <el-form-item label="SSL">
                                                            <el-input v-model="formDeviceCfg.mqtt.ssl"></el-input>
                                                        </el-form-item>
                                                        <el-form-item>
                                                            <el-button type="primary" data-cfg="mqtt"
                                                                @click="onDeviceCfg" :loading="deviceCfgLoading">
                                                                更新
                                                            </el-button>
                                                            <el-button type="primary" plain data-cfg="mqtt"
                                                                @click="getDeviceCfg" :loading="deviceCfgLoading">
                                                                获取
                                                            </el-button>
                                                        </el-form-item>
                                                    </el-form>
                                                </el-tab-pane>

                                                <el-tab-pane label="位置" name="cfg_location">
                                                    <el-form label-position="right" label-width="4.5rem"
                                                        :model="formDeviceCfg" ref="formDeviceCfg">
                                                        <el-form-item label="经度">
                                                            <el-input v-model="formDeviceCfg.location.longitude">
                                                            </el-input>
                                                        </el-form-item>
                                                        <el-form-item label="纬度">
                                                            <el-input v-model="formDeviceCfg.location.latitude">
                                                            </el-input>
                                                        </el-form-item>
                                                        <el-form-item>
                                                            <el-button type="primary" data-cfg="location"
                                                                @click="onDeviceCfg" :loading="deviceCfgLoading">
                                                                更新
                                                            </el-button>
                                                            <el-button type="primary" plain data-cfg="location"
                                                                @click="getDeviceCfg" :loading="deviceCfgLoading">
                                                                获取
                                                            </el-button>
                                                        </el-form-item>
                                                    </el-form>
                                                </el-tab-pane>

                                                <el-tab-pane label="离线设定" name="cfg_offline">
                                                    <el-form label-position="right" label-width="4.5rem"
                                                        :model="formDeviceCfg" ref="formDeviceCfg">
                                                        <el-form-item label="模式">
                                                            <el-select v-model="formDeviceCfg.mode" placeholder="请选择策略"
                                                                @change="timeChange">
                                                                <el-option label="无" value="none"></el-option>
                                                                <el-option label="天文时钟" value="geography"></el-option>
                                                                <el-option label="时间表" value="schedule"></el-option>
                                                            </el-select>
                                                        </el-form-item>
                                                        <el-form-item label="时间表：">
                                                            <el-button type="primary" size="small" plain
                                                                @click="onTimeAdd" :disabled="formDeviceCfg.disabled">新增
                                                            </el-button>
                                                            <el-button type="primary" size="small" plain
                                                                @click="onTimeReset" :disabled="formDeviceCfg.disabled">
                                                                重置
                                                            </el-button>
                                                            <div v-show="isShowTime" v-for="(time,index) in timeList">
                                                                <label>时间：</label>

                                                                <el-time-picker v-model="time.customItem" format="HH:mm"
                                                                    value-format="HH:mm" style="width: 20%;">
                                                                </el-time-picker>

                                                                <el-radio v-model="time.status" :label="1">开
                                                                </el-radio>
                                                                <el-radio v-model="time.status" :label="0">关
                                                                </el-radio>
                                                                <el-button type="primary" plain size="small"
                                                                    @click="onDelTime(index)">删除</el-button>

                                                            </div>
                                                        </el-form-item>

                                                        <el-form-item>
                                                            <el-button type="primary" data-cfg="timetable"
                                                                @click="onDeviceCfg" :loading="deviceCfgLoading">
                                                                更新
                                                            </el-button>
                                                            <el-button type="primary" plain data-cfg="timetable"
                                                                @click="getDeviceCfg" :loading="deviceCfgLoading">
                                                                获取
                                                            </el-button>
                                                        </el-form-item>
                                                    </el-form>
                                            </el-tabs>
                                        </el-tab-pane>
                                        <el-tab-pane label="系统管理" name="sys">
                                            <el-tabs v-model="sysTabActiveName" tab-position="left">
                                                <el-tab-pane label="文件传输" name="sys_file">
                                                    <el-form label-position="right" label-width="4.5rem"
                                                        :model="formDeviceFile" ref="formDeviceFile">
                                                        <label>文件传输</label>
                                                        <el-form-item label="文件">
                                                            <!-- 选中文件即上传 -->
                                                            <!-- <el-upload class="upload-ota" :action="actionUrl"
                                                                :file-list="fileList" :on-success="uploadSuccess"> -->
                                                            <el-upload class="upload-demo" :limit="1" :action="'none'"
                                                                ref='upload' :on-change="onChange" :on-remove="onRemove"
                                                                multiple :http-request="uploadFile" multiple
                                                                show-file-list>
                                                                <el-button size="small" plain type="primary">上传文件
                                                                </el-button>
                                                                <div slot="tip" class="el-upload__tip">
                                                                    上传文件路径示例：http://example.com/firmware.xx</div>
                                                            </el-upload>
                                                            <!-- 自定义上传方式 点击上传按钮才提交文件-->
                                                            <!-- <el-upload :action="'none'" :auto-upload="false" ref='upload'
                                                                :on-change="onChange" :on-remove="onRemove" multiple
                                                                show-file-list>
                                                                <el-button size="small" type="primary">点击上传</el-button>
                                                                <div slot="tip" class="el-upload__tip">只能上传pdf文件</div>
                                                            </el-upload>
                                                            <el-button icon="el-icon-upload" type="primary"
                                                                style="margin-top: 20px;" @click="submitUpload">上传</el-button> -->
                                                        </el-form-item>
                                                        <el-form-item label="远程路径">
                                                            <el-input v-model="fileUrl" placeholder="远程路径" size="small"
                                                                width="20%" clearable></el-input>
                                                            <br>
                                                            <el-button type="primary" plain data-ota="sendFile"
                                                                @click="onDeviceFile">推送
                                                                <!-- onDeviceOtaSend -->
                                                            </el-button>
                                                        </el-form-item>
                                                    </el-form>
                                                </el-tab-pane>
                                                <el-tab-pane label="OTA" name="sys_ota">
                                                    <el-form label-position="right" label-width="4.5rem"
                                                        :model="formDeviceOta" ref="formDeviceOta">
                                                        <el-form-item label="固件更新">
                                                            <el-button type="primary" plain data-ota="version"
                                                                @click="onDeviceOta">版本查询
                                                            </el-button>
                                                            <label>{{version}}</label>
                                                        </el-form-item>
                                                        <el-form-item label="固件：">
                                                            <el-upload class="upload-demo" :limit="1" :action="'none'"
                                                                ref='upload' :on-change="onChange" :on-remove="onRemove"
                                                                multiple :http-request="uploadFile" multiple
                                                                show-file-list>
                                                                <el-button size="small" plain type="primary">上传固件
                                                                </el-button>
                                                                <div slot="tip" class="el-upload__tip">
                                                                    固件路径示例：http://example.com/firmware.bin</div>
                                                            </el-upload>

                                                        </el-form-item>
                                                        <el-form-item label="版本号：">
                                                            <el-input v-model="otaVersion" placeholder="版本号"
                                                                size="small" width="20%" clearable></el-input>
                                                            <br>
                                                            <el-button type="primary" plain data-ota="sendVersion"
                                                                @click="onDeviceOta">推送
                                                                <!-- onDeviceOtaSend -->
                                                            </el-button>
                                                        </el-form-item>
                                                    </el-form>
                                                </el-tab-pane>
                                                <el-tab-pane label="虚拟机" name="sys_lua">
                                                    <el-form label-position="right" label-width="6rem"
                                                        :model="formDeviceLua" ref="formDeviceLua">
                                                        <el-form-item label="虚拟机状态:">
                                                            <div>
                                                                <el-button type="primary" plain size="small"
                                                                    @click="luaSearch">
                                                                    查询
                                                                </el-button>
                                                                <div>
                                                                    <p>{{luaStatus}}</p>
                                                                </div>
                                                            </div>
                                                            <div>
                                                                <el-button type="primary" plain size="small"
                                                                    @click="luaError">
                                                                    错误信息
                                                                </el-button>
                                                                <div>
                                                                    <p>{{luaErrorInfo}}</p>
                                                                </div>
                                                            </div>
                                                        </el-form-item>
                                                        <el-form-item label="控制:">
                                                            <el-button type="primary" plain size="small"
                                                                @click="luaStart">
                                                                启动
                                                            </el-button>
                                                            <el-button type="primary" plain size="small"
                                                                @click="luaStop">停止
                                                            </el-button>
                                                            <el-button type="primary" plain size="small"
                                                                @click="luaReset">
                                                                重启
                                                            </el-button>
                                                        </el-form-item>
                                                    </el-form>
                                                </el-tab-pane>
                                                <el-tab-pane label="系统重启" name="sys_reboot">
                                                    <el-button type="primary" size="small" plain @click="sysReboot">重启
                                                    </el-button>
                                                </el-tab-pane>
                                            </el-tabs>
                                        </el-tab-pane>
                                    </el-tabs>
                                </template>
                            </div>
                        </el-card>
                    </el-col>
                    <el-col :md="24" :lg="18" class="card-list">
                        <el-card class="box-card">
                            <div slot="header" class="clearfix">
                                <span>设备列表</span>
                            </div>
                            <div class="device-list" v-loading="deviceTabLoading">
                                <el-row>
                                    <el-col :md="24" :lg="12" :xl="8" v-for="(device, index) in devices"
                                        v-bind:key="device.device_id">
                                        <el-card class="box-card" :body-style="{ padding: '0px' }">
                                            <div slot="header" class="clearfix">
                                                <span>{{device.device_id}}</span>
                                                <el-tooltip class="item" effect="dark" content="删除设备" placement="top">
                                                    <el-button
                                                        style="float: right; margin-top: -0.95rem;font-size: 1.5rem;"
                                                        type="text" :data-deviceid="device.device_id"
                                                        @click="onDeviceDelete"><i class="el-icon-circle-close"></i>
                                                    </el-button>
                                                </el-tooltip>
                                            </div>
                                            <div style="padding: 1rem;">
                                                <table width="100%" cellpadding="2" id="table">
                                                    <tr>
                                                        <td>开关数量</td>
                                                        <td align="right">{{device.switchNum}}</td>
                                                    </tr>
                                                    <tr>
                                                        <td>是否从设备</td>
                                                        <td align="right">{{device.isSlaveDevice}}</td>
                                                    </tr>
                                                    <tr>
                                                        <td>开关状态</td>
                                                        <td v-for="i in device.switchNum" align="right">
                                                            <el-switch v-model="device.switch_state[i - 1]"
                                                                active-color="#13ce66" inactive-color="#ff4949"
                                                                disabled>
                                                            </el-switch>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td>电压</td>
                                                        <td v-for="i in device.switchNum" align="right">
                                                            {{device.voltage[i - 1]}}</td>
                                                        <td>V</td>
                                                    </tr>
                                                    <tr>
                                                        <td>电流</td>
                                                        <td v-for="i in device.switchNum" align="right">
                                                            {{device.current[i - 1]}}</td>
                                                        <td>mA</td>
                                                    </tr>
                                                    <tr>
                                                        <td>漏电电流</td>
                                                        <td v-for="i in device.switchNum" align="right">
                                                            {{device.leak_current[i - 1]}}</td>
                                                        <td>mA</td>
                                                    </tr>
                                                    <tr>
                                                        <td>频率</td>
                                                        <td v-for="i in device.switchNum" align="right">
                                                            {{device.frequency[i - 1]}}</td>
                                                        <td>Hz</td>
                                                    </tr>
                                                    <tr>
                                                        <td>有功功率</td>
                                                        <td v-for="i in device.switchNum" align="right">
                                                            {{device.power_p[i - 1]}}</td>
                                                        <td>W</td>
                                                    </tr>
                                                    <tr>
                                                        <td>无功功率</td>
                                                        <td v-for="i in device.switchNum" align="right">
                                                            {{device.power_q[i - 1]}}</td>
                                                        <td>Var</td>
                                                    </tr>
                                                    <tr>
                                                        <td>视在功率</td>
                                                        <td v-for="i in device.switchNum" align="right">
                                                            {{device.power_s[i - 1]}}</td>
                                                        <td>VA</td>
                                                    </tr>
                                                    <tr>
                                                        <td>有功电能</td>
                                                        <td v-for="i in device.switchNum" align="right">
                                                            {{device.energy_p[i - 1]}}</td>
                                                        <td>kWh</td>
                                                    </tr>
                                                    <tr>
                                                        <td>无功电能</td>
                                                        <td v-for="i in device.switchNum" align="right">
                                                            {{device.energy_q[i - 1]}}</td>
                                                        <td>kVarh</td>
                                                    </tr>

                                                    <tr>
                                                        <td>pwm</td>
                                                        <td align="right">
                                                            {{device.pwm_state}}</td>
                                                        <td>%</td>
                                                    </tr>
                                                    <tr>
                                                        <td>0~10v</td>
                                                        <td align="right">{{device.v0_10_state}}</td>
                                                        <td>%</td>
                                                    </tr>
                                                    <tr>
                                                        <td>倾斜度</td>
                                                        <td align="right">{{device.tilt}}</td>
                                                        <td>deg</td>
                                                    </tr>
                                                    <tr>
                                                        <td>信号强度</td>
                                                        <td align="right">{{device.signal}}</td>
                                                        <td>
                                                            <el-progress :show-text=false :stroke-width="16"
                                                                :percentage="device.sig_percentage"
                                                                :color="customColorMethod" status="exception">
                                                            </el-progress>
                                                        </td>
                                                    </tr>
                                                </table>
                                            </div>
                                        </el-card>
                                    </el-col>
                                </el-row>
                            </div>
                        </el-card>
                    </el-col>
                </el-row>
            </el-main>
            <!-- <el-footer>Footer</el-footer> -->
        </el-container>

    </div>
</body>
<script>
    /*
 * 自定义函数
 */
    // 对Date的扩展，将 Date 转化为指定格式的String   
    // 月(M)、日(d)、小时(H)、分(m)、秒(s)、季度(q) 可以用 1-2 个占位符，   
    // 年(y)可以用 1-4 个占位符，毫秒(S)只能用 1 个占位符(是 1-3 位的数字)   
    // 例子：   
    // (new Date()).Format("yyyy-MM-dd HH:mm:ss.S") ==> 2006-07-02 08:09:04.423   
    // (new Date()).Format("yyyy-M-d H:m:s.S")      ==> 2006-7-2 8:9:4.18   
    Date.prototype.Format = function (fmt) { //author: meizz   
        let o = {
            "M+": this.getMonth() + 1,                 //月份   
            "d+": this.getDate(),                    //日   
            "h+": this.getHours(),                   //小时   
            "m+": this.getMinutes(),                 //分   
            "s+": this.getSeconds(),                 //秒   
            "q+": Math.floor((this.getMonth() + 3) / 3), //季度   
            "S": this.getMilliseconds()             //毫秒   
        };
        if (/(y+)/.test(fmt))
            fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
        for (let k in o)
            if (new RegExp("(" + k + ")").test(fmt))
                fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
        return fmt;
    }

</script>
<script>
    let app = new Vue({
        el: '#app',
        data: function () {
            return {
                version: '',
                operation: '',
                otaVersion: '',
                fileUrl: '',
                luaStatus: '',
                luaErrorInfo: '',
                path: './public/uploads/',
                actionUrl: window.location.origin + "/device/upload",
                arrs: [{ 'value': 1, 'customItem': '' }],
                timeIndexs: 0,
                device: [],
                checkboxTag: [],
                tags: [{
                    key: "all",
                    value: "全部"
                }, {
                    key: "voltage",
                    value: "电压"
                }, {
                    key: "power_q",
                    value: "无功功率"
                }, {
                    key: "current",
                    value: "电流"
                }, {
                    key: "power_s",
                    value: "视在功率"
                }, {
                    key: "frequency",
                    value: "频率"
                }, {
                    key: "energy_p",
                    value: "有功电能"
                }, {
                    key: "leak_current",
                    value: "漏电电流"
                }, {
                    key: "energy_q",
                    value: "无功电能"
                }, {
                    key: "power_p",
                    value: "有功功率"
                }, {
                    key: "switch",
                    value: "开关"
                }],
                fileList: [],
                i: 0,
                isShow: false,//控制开关展示
                isShowTime: false,//控制时间表展示
                visible: false,
                funTabActiveName: 'action',
                cfgTabActiveName: 'cfg_mqtt',
                sysTabActiveName: 'sys_file',
                msgid: 1,
                deviceCfgLoading: false,
                deviceTabLoading: true,
                // json_api_version: "1.0.0",
                json_api_version: "2.0.0",

                formDeviceAdd: {
                    device_id: ''
                },
                formDeviceSelect: {
                    device_id: '',
                },
                formDeviceAction: {

                },
                radio: {
                    status: 1
                },
                num: [],//开关个数
                timeList: [],//时间表个数
                formDeviceTag: {
                    line_id: ''
                },
                formDeviceCfg: {
                    disabled: true,
                    mode: '',
                    timetable: {
                        mode: '',
                        schedule: []
                    },
                    mqtt: {
                        address: '',
                        port: '',
                        username: '',
                        password: '',
                        ssl: ''
                    },
                    topic: {
                        topics: []
                    },
                    location: {
                        longitude: '',
                        latitude: ''
                    },
                    offline: {
                        switch: ''
                    },
                    schedule: {
                        day: '',
                        switch: ''
                    },
                    elec_ofs: {
                        power_p1_gain: '',
                        power_q1_gain: '',
                        power_s1_gain: '',
                        phase1_gain: '',
                        hf_const: '',
                        i1_rms_ofs: '',
                        i2_rms_ofs: '',
                        u_rms_ofs: ''
                    },
                    tilt_ofs: {
                        axis_refrence: '',
                        x_offset: '',
                        y_offset: '',
                        z_offset: ''
                    },
                    report: {
                        config: '',
                        interval: '',
                        upper_threshold: '',
                        lower_threshold: '',
                        mutation: ''
                    },
                },
                formDeviceFile: {},
                formDeviceOta: {},
                formDeviceLua: {
                },

                formSub: {
                    deviceSN: ''
                },
                pwm: 50,
                v0_10: 50,
                rules: {
                    deviceSN: [
                        {
                            required: true,
                            message: '请输入设备 SN',
                            trigger: 'blur'
                        },
                        {
                            min: 12,
                            max: 12,
                            message: '设备 SN 为 12 位',
                            trigger: 'blur'
                        }
                    ]
                },
                devices: [],
                deviceDataTemplate: {
                    device_id: '0',
                    switchNum: 0,
                    isSlaveDevice: '否',
                    voltage: [],
                    current: [],
                    frequency: [],
                    power_p: [],
                    power_q: [],
                    power_s: [],
                    energy_p: [],
                    energy_q: [],
                    leak_current: [],
                    switch_state: [],
                    pwm_state: '0',
                    v0_10_state: '0',
                    tilt: '0',
                    signal: '0',
                    sig_percentage: '0'
                },
                tagList: []
            }
        },
        created: function () {
            setInterval(this.refreshData, 500);
        },

        methods: {

            initDevice(id, isFlag, num) {
                let d = {
                    device_id: id,
                    switchNum: num,
                    isSlaveDevice: isFlag,//是否从设备装置
                    voltage: [], // 电压   //voltage[0]=220
                    current: [], // 电流
                    frequency: [], // 频率
                    leak_current: [], // 漏电电流
                    power_p: [], // 有功功率
                    power_q: [], // 无功功率
                    power_s: [], // 视在功率
                    energy_p: [], // 有功电能
                    energy_q: [], // 武功电能
                    switch_state: [], // 开关状态
                    pwm_state: 0, // PWM 值
                    v0_10_state: 0, // 0-10V 值
                    tilt: 0, // 倾斜度
                    sig_percentage: 0 // 信号强度
                }

                for (let i = 0; i < num; i++) {
                    d.voltage[i] = 0;
                    d.current[i] = 0;
                    d.frequency[i] = 0;
                    d.leak_current[i] = 0;
                    d.power_p[i] = 0;
                    d.power_q[i] = 0;
                    d.power_s[i] = 0;
                    d.energy_p[i] = 0;
                    d.energy_q[i] = 0;
                    d.switch_state[i] = false;
                }

                return d;
            },
            //设备id下拉框触发事件
            selectChange() {
                let device_id = this.formDeviceSelect.device_id;
                let index = this.devices.findIndex((ele => {
                    return ele.device_id === device_id
                })
                )
                this.device = this.devices[index];
                console.log(this.device, "selectChange.device")
            },
            timeChange() {
                let mode = this.formDeviceCfg.mode;
                if (mode == 'schedule') {
                    this.formDeviceCfg.disabled = false;
                } else {
                    this.onTimeReset();
                    this.formDeviceCfg.disabled = true;
                }
            },
            //获取线路复选框的value值
            getCheckTagValue(e) {
                console.log(this.checkboxTag, "getCheckTagValue")
                if (this.checkboxTag == 'all') {
                    this.tagList = ["switch", "voltage", "energy_p", "power_q", "leak_current", "current", "energy_q", "power_s", "power_p", "frequency"]
                } else {
                    this.tagList = this.checkboxTag
                }
            },
            unique: function (arr) {
                const res = new Map();
                return arr.filter((arr) => !res.has(arr.device_id) && res.set(arr.device_id, 1));
            },
            deleteDevice: function (device_id) {
                let index = this.devices.findIndex((ele) => {
                    return ele.device_id === device_id;
                });
                //假设没有找到
                console.log(index);
                if (index === -1) {
                    return console.log('删除失败');
                }
                //删除元素
                this.devices.splice(index, 1);
                console.log(this.devices)
            },
            customColorMethod(percentage) {
                if (percentage <= 20) {
                    return '#e13131';
                } else if (percentage <= 40) {
                    return '#e1b131';
                } else if (percentage <= 60) {
                    return '#e1d331';
                } else if (percentage <= 80) {
                    return '#bae131';
                } else {
                    return '#67c23a';
                }
            },
            handleDeviceData(data) {
                let iii = 0;
                data.device.forEach(ele => {
                    let index = this.devices.findIndex((local_ele) => {
                        return local_ele.device_id === ele.device_id;
                    });
                    if (index == -1) {
                        let sw_num = 0;
                        if (ele.switchNum.length != 0) {
                            sw_num = ele.switchNum[0];
                        }

                        let template = Object.assign({}, this.initDevice(ele.device_id, ele.isSlaveDevice, sw_num));

                        this.devices.push(template);
                        this.devices = this.unique(this.devices);
                    }

                    let idx = this.devices.findIndex((local_ele) => {
                        return local_ele.device_id === ele.device_id;
                    });

                    if (idx != -1) {
                        for (let i = 0; i < ele.switchNum[0]; i++) {
                            this.devices[idx].voltage[i] = ele.voltage[i] == null ? 0 : ele.voltage[i];
                            this.devices[idx].current[i] = ele.current[i] == null ? 0 : ele.current[i];
                            this.devices[idx].frequency[i] = ele.frequency[i] == null ? 0 : ele.frequency[i];
                            this.devices[idx].leak_current[i] = ele.leak_current[i] == null ? 0 : ele.leak_current[i];
                            this.devices[idx].power_p[i] = ele.power_p[i] == null ? 0 : ele.power_p[i];
                            this.devices[idx].power_q[i] = ele.power_q[i] == null ? 0 : ele.power_q[i];
                            this.devices[idx].power_s[i] = ele.power_s[i] == null ? 0 : ele.power_s[i];
                            this.devices[idx].energy_p[i] = ele.energy_p[i] == null ? 0 : ele.energy_p[i];
                            this.devices[idx].energy_q[i] = ele.energy_q[i] == null ? 0 : ele.energy_q[i];
                            this.devices[idx].switch_state[i] = ele.switch_state[i] == 'on' ? true : false;

                        }

                        this.devices[idx].pwm_state = ele.pwm_state;
                        this.devices[idx].v0_10_state = ele.v0_10_state;
                        this.devices[idx].tilt = ele.tilt;
                        this.devices[idx].signal = ele.signal;
                        let perc = 0;
                        let signal = Number(ele.signal);
                        if (signal > 0 && signal <= 3) {
                            perc = 20;
                        }
                        else if (signal > 3 && signal <= 5) {
                            perc = 40;
                        }
                        else if (signal > 5 && signal <= 6) {
                            perc = 60;
                        }
                        else if (signal > 6 && signal <= 11) {
                            perc = 80;
                        }
                        else if (signal > 11) {
                            perc = 100;
                        }
                        this.devices[index].sig_percentage = perc;
                    }

                    this.$forceUpdate()
                });
            },
            refreshData() {
                // this.devices.forEach(element => {
                axios.get('/device/base', {
                    params: {
                        id: 'all'
                    }
                }).then((res) => {
                    // console.log(res.data);
                    this.handleDeviceData(res.data);
                    this.deviceTabLoading = false;
                }).catch((err) => {
                    // console.log(err.response.data);
                    this.deviceTabLoading = false;
                })
                //});
            },

            onDeviceAdd() {
                let device_id = this.formDeviceAdd.device_id;
                axios.post('/device/base', {
                    id: device_id
                }).then((res) => {
                    this.$notify.success({
                        title: '成功',
                        message: `成功添加设备：${device_id}`
                    });
                    let template = Object.assign({}, this.deviceDataTemplate);
                    template.device_id = device_id;
                    this.devices.push(template);
                    this.devices = this.unique(this.devices);
                }).catch((err) => {
                    console.log(err.response.data);
                    this.$notify.error({
                        title: '错误',
                        message: err.response.data
                    });
                });
            },
            onDeviceDelete(ele) {
                let device_id = ele.currentTarget.dataset.deviceid;

                axios.delete('/device/base', {
                    data: { id: device_id }
                }).then((res) => {
                    this.deleteDevice(device_id);
                    this.$notify.success({
                        title: '成功',
                        message: `成功删除设备：${device_id}`
                    });
                }).catch((err) => {
                    console.log(err.response.data);
                    this.$notify.error({
                        title: '错误',
                        message: err.response.data
                    });
                });
            },
            luaReset() {
                let device_id = this.formDeviceSelect.device_id;
                axios.post('/device/luaReset', {
                    data: { id: device_id }
                }).then((res) => {
                    this.$notify.success({
                        title: '成功',
                        message: `成功重新启动虚拟机`
                    })
                })
            },
            luaStart() {
                let device_id = this.formDeviceSelect.device_id;
                axios.post('/device/luaStart', {
                    data: { id: device_id }
                }).then((res) => {
                    this.$notify.success({
                        title: '成功',
                        message: `成功启动虚拟机`
                    })
                })
            }, luaStop() {
                let device_id = this.formDeviceSelect.device_id;
                axios.post('/device/luaStop', {
                    data: { id: device_id }
                }).then((res) => {
                    this.$notify.success({
                        title: '成功',
                        message: `成功停止虚拟机`
                    })
                })
            }, luaSearch() {
                let device_id = this.formDeviceSelect.device_id;
                axios.post('/device/luaSearch', {
                    data: { id: device_id }
                }).then((res) => {
                    this.luaStatus = res.data;
                    this.$notify.success({
                        title: '成功',
                        message: `成功查询虚拟机信息`
                    })
                })
            }, luaError() {
                let device_id = this.formDeviceSelect.device_id;
                axios.post('/device/luaError', {
                    data: { id: device_id }
                }).then((res) => {
                    this.luaErrorInfo = res.data;
                    this.$notify.success({
                        title: '成功',
                        message: `成功获取虚拟机错误信息`
                    })
                })
            },
            //系统重启
            sysReboot() {
                let deviceId = this.formDeviceSelect.device_id;
                axios.post('/device/sysReboot', {
                    data: { id: deviceId }
                }).then((res) => {
                    this.$notify.success({
                        title: "成功",
                        message: "系统重启成功"
                    })
                })
            },
            //新增开关
            onSwitchAdd() {
                this.isShow = true
                this.num.push({
                    status: 1,
                    indexs: this.i
                });
                this.i = this.i + 1;
                console.log(this.num, "num")
            },
            onSwitchReset() {
                this.isShow = false
                this.num = [];
                this.i = 0;
            },
            //删除一行开关
            del(index) {
                console.log(index, "index")
                this.num.splice(index, 1)
                console.log(this.num, "num")
            },
            //发送信息动作
            onDeviceAction(ele) {
                let actionDataset = ele.currentTarget.dataset.action;
                let device_id = this.formDeviceSelect.device_id;
                let postData;
                console.log(actionDataset, "发送信息")
                let nums;
                switch (actionDataset) {
                    case 'relay_on':
                        nums = [{ "status": "1", "indexs": "0" }];
                        postData = {
                            id: device_id,
                            action_type: 'switch',
                            num: nums
                        }
                        break;
                    case 'relay_off':
                        nums = [{ "status": "0", "indexs": "0" }];
                        postData = {
                            id: device_id,
                            action_type: 'switch',
                            num: nums
                        }
                        break;
                    case 'rs485_on':
                        nums = [{ "status": "1", "indexs": "0" }];
                        postData = {
                            id: device_id,
                            action_type: 'rs485',
                            num: nums
                        }
                        break;
                    case 'rs485_off':
                        nums = [{ "status": "0", "indexs": "0" }];
                        postData = {
                            id: device_id,
                            action_type: 'rs485',
                            action_id: '0',
                            num: nums
                        }
                        break;
                    case 'switchInfo':
                        postData = {
                            id: device_id,
                            action_type: 'switch',
                            num: this.num
                        }
                        axios.post('/device/action', postData)
                            .then((res) => {
                                this.$notify.success({
                                    title: '成功',
                                    message: ''
                                });
                            })
                            .catch((err) => {
                                console.log(err.response.data);
                                this.$notify.error({
                                    title: '错误',
                                    message: err.response.data
                                });
                            });
                        break;
                    default:
                        break;
                }

                if (postData != undefined && actionDataset != 'switchInfo') {
                    axios.post('/device/action', postData)
                        .then((res) => {
                            //console.log(res.data);
                            this.$notify.success({
                                title: '成功',
                                message: ''
                            });
                        })
                        .catch((err) => {
                            console.log(err.response.data);
                            this.$notify.error({
                                title: '错误',
                                message: err.response.data
                            });
                        });
                }
            },
            onDeviceActionPwm(val) {
                let device_id = this.formDeviceSelect.device_id;
                let postData = {
                    id: device_id,
                    action_type: 'pwm',
                    action_id: '0',
                    action: `${val}`
                };

                axios.post('/device/action', postData)
                    .then((res) => {
                        //console.log(res.data);
                        this.$notify.success({
                            title: '成功',
                            message: ''
                        });
                    })
                    .catch((err) => {
                        console.log(err.response.data);
                        this.$notify.error({
                            title: '错误',
                            message: err.response.data
                        });
                    });
            },
            onDeviceActionV0_10(val) {
                let device_id = this.formDeviceSelect.device_id;
                let postData = {
                    id: device_id,
                    action_type: 'v0_10',
                    action_id: '0',
                    action: `${val}`
                };

                axios.post('/device/action', postData)
                    .then((res) => {
                        //console.log(res.data);
                        this.$notify.success({
                            title: '成功',
                            message: ''
                        });
                    })
                    .catch((err) => {
                        console.log(err.response.data);
                        this.$notify.error({
                            title: '错误',
                            message: err.response.data
                        });
                    });
            },
            //tag
            onDeviceTag(ele) {
                let tagDataset = this.tagList;
                let device_id = this.formDeviceSelect.device_id;
                let line_id = this.formDeviceTag.line_id;

                let postData = {
                    id: device_id,
                    tag: tagDataset,
                    lineId: line_id
                }
                console.log(tagDataset, "tagDataSet", line_id, "line_id", postData, "postData");

                axios.put('/device/tag', postData)
                    .then((res) => {
                        //console.log(res.data);
                        this.$notify.success({
                            title: '成功',
                            message: ''
                        });
                    })
                    .catch((err) => {
                        console.log(err.response.data);
                        this.$notify.error({
                            title: '错误',
                            message: err.response.data
                        });
                    });
            },//新增时间表
            onTimeAdd() {
                this.isShowTime = true
                this.timeList.push({
                    status: 1,
                    customItem: '',
                    value: this.timeIndexs
                });
                this.timeIndexs++;
                // this.timeIndexs = this.timeIndexs + 1;
                // this.formDeviceCfg.schedule.day = this.timeIndexs + 1;
                console.log(this.timeList, "timeList", this.timeIndexs, "value")
            },
            onTimeReset() {
                this.isShowTime = false
                this.timeList = [];
                this.timeIndexs = 0;
            },
            //删除一行开关
            onDelTime(index) {
                console.log(index, "index")
                this.timeList.splice(index, 1)
                console.log(this.timeList, "timeList")
            },
            onDeviceCfg(ele) {
                let cfgDataset = ele.currentTarget.dataset.cfg;
                let device_id = this.formDeviceSelect.device_id;
                console.log(cfgDataset, "cfgDatasSet", this.timeList.customItem, "customItem", this.num);

                let cfg = undefined;

                switch (cfgDataset) {
                    case 'mqtt':
                        cfg = {
                            config: 'mqtt',
                            content: {
                                server: this.formDeviceCfg.mqtt.address,
                                port: String(this.formDeviceCfg.mqtt.port),
                                username: this.formDeviceCfg.mqtt.username,
                                password: this.formDeviceCfg.mqtt.password,
                                ssl: '0'
                            }
                        };
                        break;
                    case 'topic':
                        cfg = {
                            config: 'topics',
                            content: this.formDeviceCfg.topic
                        };
                        break;
                    case 'location':
                        cfg = {
                            config: 'location',
                            content: {
                                longitude: String(this.formDeviceCfg.location.longitude),
                                latitude: String(this.formDeviceCfg.location.latitude)
                            }
                        };
                        break;
                    case 'timetable':
                        console.log(this.timeList, "timetable.timeList")
                        let switchTime = [];
                        let switchStatus;
                        for (let i = 0; i < this.timeList.length; i++) {
                            const element = this.timeList[i];
                            if (element.status == 0) {
                                switchStatus = 'off'
                            } else if (element.status == 1) {
                                switchStatus = 'on'
                            }
                            switchTime.push({
                                time: element.customItem,
                                switch: switchStatus
                            });
                        }
                        console.log(switchTime, "switchTime")
                        cfg = {
                            config: 'timetable',
                            content: {
                                mode: this.formDeviceCfg.mode,
                                schedule: switchTime
                            }
                        }
                        break;
                    case 'elec_ofs':
                        cfg = {
                            config: 'elec_ofs',
                            content: this.formDeviceCfg.elec_ofs
                        };
                        break;
                    case 'tilt_ofs':
                        cfg = {
                            config: 'tilt_ofs',
                            content: this.formDeviceCfg.tilt_ofs
                        };
                        break;
                    case 'report':
                        cfg = {
                            config: this.formDeviceCfg.report.config,
                            content: {
                                interval: String(this.formDeviceCfg.report.interval),
                                upper_threshold: String(this.formDeviceCfg.report.upper_threshold),
                                lower_threshold: String(this.formDeviceCfg.report.lower_threshold),
                                mutation: String(this.formDeviceCfg.report.mutation),
                            }
                        };
                        break;
                    default:
                        break;
                }

                if (cfg != undefined) {
                    let postData = {
                        id: device_id,
                        cfg: JSON.stringify(cfg)
                    }
                    this.deviceCfgLoading = true;
                    axios.put('/device/cfg', postData)
                        .then((res) => {
                            //console.log(res.data);
                            this.$notify.success({
                                title: '成功',
                                message: ''
                            });
                            this.deviceCfgLoading = false;
                        })
                        .catch((err) => {
                            console.log(err.response.data);
                            this.$notify.error({
                                title: '错误',
                                message: err.response.data
                            });
                            this.deviceCfgLoading = false;
                        });
                }

            },
            getDeviceCfg(ele) {
                console.log(this.formDeviceCfg.mode, "getDeviceCfg.mode")
                let cfgDataset = ele.currentTarget.dataset.cfg;
                let device_id = this.formDeviceSelect.device_id;
                console.log(cfgDataset);

                let cfg = undefined;

                switch (cfgDataset) {
                    case 'mqtt':
                        cfg = 'mqtt';
                        break;
                    case 'topics':
                        cfg = 'topics';
                        break;
                    case 'location':
                        cfg = 'location';
                        break;
                    case 'timetable':
                        cfg = 'timetable';
                        break;
                    case 'elec_ofs':
                        cfg = 'elec_ofs';
                        break;
                    case 'tilt_ofs':
                        cfg = 'tilt_ofs';
                        break;
                    case 'report':
                        cfg = this.formDeviceCfg.report.config;
                        break;
                    default:
                        break;
                }

                if (cfg != undefined) {
                    let postData = {
                        id: device_id,
                        cfg: cfg
                    }
                    this.deviceCfgLoading = true;
                    axios.get('/device/cfg', {
                        params: postData
                    }).then((res) => {
                        // console.log(res.data);
                        this.handleGetDeviceCfg(res.data);
                        this.$notify.success({
                            title: '成功',
                            message: ''
                        });
                        this.deviceCfgLoading = false;
                    }).catch((err) => {
                        // console.log(JSON.stringify(err));
                        this.$notify.error({
                            title: '错误',
                            message: err.response.data
                        });
                        this.deviceCfgLoading = false;
                    });
                }
            },
            //file
            onDeviceFile(ele) {
                let postData = {
                    id: this.formDeviceSelect.device_id,
                    fileOperation: this.fileUrl + "," + this.operation
                }
                axios.post('/device/file', postData).then((res) => {
                    //console.log(res.data);
                    this.$notify.success({
                        title: '推送成功',
                        message: ''
                    });
                    this.deviceCfgLoading = false;
                }).catch((err) => {
                    console.log(err.response.data);
                    this.$notify.error({
                        title: '错误',
                        message: err.response.data
                    });
                    this.deviceCfgLoading = false;
                });
            },
            //ota
            onDeviceOta(ele) {
                let ota = ele.currentTarget.dataset.ota;
                // axios.post('/device/ota')
                let operations;
                switch (ota) {
                    case 'version':
                        operations = "version"
                        break;
                    case 'sendVersion':
                        //版本号+路径
                        operations = this.otaVersion + "," + this.operation
                        break;
                    default:
                        break;
                }
                let postData = {
                    id: this.formDeviceSelect.device_id,
                    otaOperation: operations
                }
                axios.post('/device/ota', postData).then((res) => {
                    this.version = res.data;
                    console.log(res.data);
                    this.$notify.success({
                        title: '成功',
                        message: ''
                    });
                    this.deviceCfgLoading = false;
                }).catch((err) => {
                    console.log(err.response.data);
                    this.$notify.error({
                        title: '错误',
                        message: err.response.data
                    });
                    this.deviceCfgLoading = false;
                });
                console.log(ota, "ele", ele);
            },
            uploadSuccess(file, fileList) {
                this.operation = window.location.origin + "/uploads/" + fileList.name;
                console.log("this.operation", this.operation, "fileList", fileList, "file=>", file)
            },
            onChange(file, filelist) {
                //file.raw 才是真实的 file 对象
                this.fileList.push(file.raw)

            }, onRemove(file, fileList) {
                //file.raw 才是真实的 file 对象
                this.fileList.splice(this.fileList.indexOf(file.raw), 1)
            }, submitUpload() {
                console.log("提交文件")
                let formData = new FormData();
                // 向 formData 对象中添加文件
                this.fileList.forEach(file => {
                    formData.append('file', file);
                })
                //设置文件保存路径
                formData.append('path', this.path);
                axios.post('/device/upload', formData).then(res => {
                    console.log(res, "d")
                })
            },
            uploadFile(val) {
                this.operation = window.location.origin + "/uploads/" + val.file.name;
                let formData = new FormData();
                // 向 formData 对象中添加文件
                this.fileList.forEach(file => {
                    formData.append('file', file);
                })
                //设置文件保存路径
                formData.append('path', this.path);
                axios.post('/device/upload', formData).then(res => {
                    console.log(res, "上传成功")
                })
            },
            /**
             * 将获取到的信息渲染到页面
             **/
            handleGetDeviceCfg(data) {
                let formCfg = this.formDeviceCfg;
                let content = data.content;
                console.log("handleGetDeviceCfg.data:", data)
                if (content == 'null') {
                    return;
                }
                switch (data.config) {
                    case 'mqtt':
                        formCfg.mqtt = content;
                        break;
                    case 'topics':
                        formCfg.topic = content;
                        break;
                    case 'location':
                        formCfg.location = content;
                        break;
                    case 'timetable':
                        formCfg.timetable = content;
                        // console.log("mode.show",formCfg.mode)
                        formCfg.mode = data.content.mode;//模式选中值设置

                        if (this.formDeviceCfg.mode == 'schedule') {
                            this.isShowTime = true;//时间表信息展示
                            this.formDeviceCfg.disabled = false;
                            let switchInfo;//开关信息转换
                            //循环往时间表信息数组赋值
                            for (let i = 0; i < data.content.schedule.length; i++) {
                                const element = data.content.schedule[i];
                                if (element.switch == "on") {
                                    switchInfo = 1
                                }
                                if (element.switch == "off") {
                                    switchInfo = 0
                                }
                                this.timeList.push({
                                    status: switchInfo,
                                    customItem: element.time,
                                    value: i
                                })
                            }
                        }
                        break;
                    case 'elec_ofs':
                        formCfg.elec_ofs = content;
                        break;
                    case 'tilt_ofs':
                        formCfg.tilt_ofs = content;
                        break;
                    case (String(data.config).match(/rpt_/) || {}).input:
                        formCfg.report = content;
                        formCfg.report.config = data.config;
                        break;
                    default:
                        break;
                }
            },
        }
    })

</script>
<style>
    .el-container {
        margin-left: 1%;
        margin-right: 1%;
    }

    .card-list .el-card {
        margin-top: 1rem;
    }

    .button-list button {
        margin-bottom: 1rem;
    }

    .device-list .el-card {
        margin: 0.5rem;
    }

    .elec-list {
        list-style: none;
        margin: 0;
        padding: 1rem;
    }

    .elec-list li {
        margin-bottom: 0.25rem;
    }
</style>

</html>